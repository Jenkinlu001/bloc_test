# SCP免密传输
在linux下开发时，经常需要登录到其他的设备上，例如虚拟机内ubuntu、树莓派等等，经常涉及到传输文件的操作，传输文件有很多中方法，如物理磁盘拷贝，基于网络的samba服务、SCP传输、ftp文件传输等等，今天我们就来聊聊出场频率最高的SCP传输。
## SCP的使用
在linux环境中，当我们需要在两台机器之间传输数据时，经常会用到SCP指令，(SCP指令其实就是基于SCP(secure copy)协议实现的应用程序)，SCP的使用示例：

    scp a.out downey@192.168.1.101:/home/donwey
从示例可以看出，上述示例为：*将a.out这个文件传送给IP为192.168.1.101目标机器的/home/downey目录下*，如果是第一次传输，终端会显示：

    The authenticity of host '192.168.4.77 (192.168.4.77)' can't be established.ECDSA key fingerprint is 7f:d8:d6:37:4f:a7:6f:8d:a3:00:45:7f:0d:xx:xx:xx.Are you sure you want to continue connecting (yes/no)? 
接着键入：

    yes
然后系统会提示你输入账户和密码，注意这个密码指的是目标机器上用户的账号密码，正确输入之后传输完成。

## 背后的实现原理
知道怎么做，当然还需要知道为什么这么做，这才是一个学习者应有的态度，所以我们需要来探究scp指令背后的秘密。  

### 预备知识
在介绍SCP协议之前，我们先得了解一下SSH协议，和计算机中的加密方式。
#### 对称加密
对称加密，即在数据传输过程中对数据进行加密和解密的算法使用同一个密钥，这种加密算法有什么弊端呢？当客户端需要与服务器端进行数据传输时，不管是由客户端还是由服务端产生的密钥，都得将这个密钥传给对方才能实现加解密，而在传输的过程中就可能造成密钥的泄漏。
#### 非对称加密  
针对对称加密带来的风险，非对称加密则解决了这个问题，即将加解密使用的密钥分为公钥和私钥，公钥可以公开，而私钥则由密钥生成者保存，客户端使用公钥进行加密，而服务端用私钥进行解密，且目前来说还没有出现能从公钥推算出私钥的的破解机制，所以相对于对称加密而言，这种加密方式更加安全，但是这种加密方式的缺点是会占用更多的计算机资源。
#### 常见的加密方式
对称加密：
* DES(Data Encryption Standard):加密速度较快，适合加密大量数据的场合。
* 3DES：基于DES的加密算法，顾名思义，这是对一块数据用三个不同的密钥进行三次加密，显而易见强度更高，更安全。
* RC2和RC4：用变长密钥对大量数据进行加密，速度比DES更快
* IDEA:（International Data Encryption Algorithm）国际数据加密算法，使用 128 位密钥提供非常强的安全性；
* AES:高级加密标准，是下一代的加密算法标准，速度快，安全级别高，这个加密算法被广泛应用。
非对称加密：
* RSA:是一个支持变长密钥的公共密钥算法，需要加密的文件块的长度也是可变的，目前使用最广的加密算法
* Diff ieˉHellman：每次交换数据的时候都使用一组新的密钥，有效地防止了第三方获得私钥后解密所有信息，但是同时对中间人攻击的防护比较薄弱。
#### SSH协议
SSH是一种加密的网络传输协议，可在不安全的网络中为网络服务提供安全的传输环境，最常见的运用是远程登录。SSH的交互流程是这样的：
![ssh flow](https://raw.githubusercontent.com/linux-downey/bloc_test/master/article/linux/SCP_without_pswd/ssh_flow.png)  

从图中我们可以看到整个登录流程，这是在客户端第一次登录服务器时的标准流程，我们再来仔细分析这个流程：
1. 客户端发送请求：这个请求其实就是ssh登录请求，即发起者拥有服务器上的某个用户的账号密码，以远程登录的方式来操作服务器，这个时候只提供服务器上的用户名而不会提供密码。
2. 服务器将公钥发送给客户端，这个公钥是给客户端进行数据加密用的
3. 客户端收到服务器公钥，确定是否继续连接？为什么会有这么一个流程呢，既然我指定了就是要连接服务器，为什么还要让我确认一次,这会不会是多此一举呢？其实不然，这是为了防范中间人攻击。
4. 客户端用公钥对密码进行加密，再发送给服务器
5. 服务器用私钥对密码进行解密，返回登录结果
####中间人攻击
刚刚提到中间人攻击，我们就来看看什么是中间人攻击？我们大可以想一想，在一个不安全的网络中，如果我发送的请求被第三方截获，而第三方把他的公钥发给我，而我用他的公钥对密码进行加密，然后再发送给他，他就获得了完整的账号密码，这时候他就可以拿着从我这儿窃取来的信息登录服务器。
但是话又说回来，在一个不安全的网络中，我们改怎样防范这种攻击方式呢？一般有两种方法：  
1. 服务器将公钥公布在官方或者以其他方式公开，让用户可以查到进行对比，如果不匹配，就在第三步的时候取消登录即可。
2. CA证书，由一个权威机构CA对公钥进行认证，CA机构的数字签名使得攻击者不能伪造和篡改证书。在SET交易中，CA不仅对持卡人、商户发放证书，还要对获款的银行、网关发放证书，CA 也拥有一个证书（内含公钥）和私钥。网上的公众用户通过验证 CA 的签字从而信任 CA ，任何人都可以得到 CA 的证书（含公钥），用以验证它所签发的证书。如果一个用户想鉴别另一个证书的真伪，他就用 CA 的公钥对那个证书上的签字进行验证，一旦验证通过，该证书就被认为是有效的。
###SCP的传输
说回到SCP的传输，SCP的传输第一步就是